<!DOCTYPE html>
<html lang="en">
<head>
  <title>Metro - Rail Time Map</title>
<meta property="og:description" content="Real-time rail vehicle locations for Metro." />  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/mapbox-gl-esri-sources@0.0.7/dist/mapbox-gl-esri-sources.js"></script>
  <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@3.5.1/dist/maplibre-gl.css' />
  <!-- Include the Font Awesome library -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

  <script src='https://unpkg.com/maplibre-gl@3.5.1/dist/maplibre-gl.js'></script>
  <style>
      body { margin: 0; padding: 0; }

      html, body, #map { height: 100%; }

        .marker {
            display: block;
            visibility: visible !important;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 0;

        }
        .arrow {
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 10px solid black;
            position: relative;
            top: -5px;
        }   

    .maplibregl-ctrl-icon.home-icon {
        background-color: #fff;
        border: none;
        border-radius: 3px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        margin: 5px;
        padding: 5px;
        width: auto;
        height: auto;
        outline: none;
    }

    .maplibregl-ctrl-icon.home-icon:hover {
        background-color: #f8f8f8;
    }

    .maplibregl-ctrl-icon.home-icon i {
        color: #404040;
        font-size: 14px;
    }
    .map-title {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 18px;
        font-weight: bold;
        color: #404040;
        background-color: #f8f8f8; /* Light gray background */
        padding: 10px; /* Padding around the text */
        border-radius: 5px; /* Rounded corners */
    }

    .update-time {
        position: absolute;
        top: 60px; /* Adjust this value as needed */
        right: 10px;
        font-size: 14px;
        color: #404040;
    }
    </style>
</head>
<body>
<div id="map"></div>
<script>
// config options
  const ESRI_KEY =  "AAPKccc2cf38fecc47649e91529acf524abflSSkRTjWwH0AYmZi8jaRo-wdpcTf6z67CLCkOjVYlw3pZyUIF_Y4KGBndq35Y02z";
  const MAPTILER_KEY = "KydZlIiVFdYDFFfQ4QYq"
  const basemapEnum = "65aff2873118478482ec3dec199e9058";


// Create a map of vehicle IDs to markers
let markers = {};

// Get the current time
const now = new Date();

// map setup

  let map = new maplibregl.Map({
    container: 'map',
    center: [-118.25133692966446, 34.05295151499077], 
    zoom: 9,
    pitch: 20,
    bearing: 0,
    container: 'map',
    antialias: true,
    minZoom: 8, // Minimum zoom level
    style: `https://basemapstyles-api.arcgis.com/arcgis/rest/services/styles/v2/styles/items/${basemapEnum}?token=${ESRI_KEY}`,
  });
// Create a div for the map title
const titleDiv = document.createElement('div');
titleDiv.classList.add('map-title');
titleDiv.textContent = 'Metro Real Time Rail Locations';

// Create a div for the update time
const updateTimeDiv = document.createElement('div');
updateTimeDiv.classList.add('update-time');
updateTimeDiv.textContent = `Updated at ${now.toLocaleTimeString()}`;

// Add the title div and update time div to the map container
map.getContainer().appendChild(titleDiv);
map.getContainer().appendChild(updateTimeDiv);


  // The 'building' layer in the streets vector source contains building-height
  // data from OpenStreetMap.
  map.on('load', () => {
      // Insert the layer beneath any symbol layer.
      const layers = map.getStyle().layers;

      let labelLayerId;
      for (let i = 0; i < layers.length; i++) {
          if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
              labelLayerId = layers[i].id;
              break;
          }
      }
      new mapboxglEsriSources.TiledMapService('imagery-source', map, {
        url: 'https://tiles.arcgis.com/tiles/TNoJFjk1LsD45Juj/arcgis/rest/services/Map_RGB_Vector_Offset_RC5/MapServer'
    })

    map.addLayer({
      id: 'imagery-layer',
      type: 'raster',
      source: 'imagery-source'
  })
  let apiUrl = 'https://api.metro.net/LACMTA_Rail/vehicle_positions?format=geojson'

      map.addSource('vehicles', {
        type: 'geojson',
        data: apiUrl,
    });
// Create a map of vehicle IDs to markers
let markers = {};
window.setInterval(function () {
    fetch(apiUrl)
    .then(response => response.json())
    .then(data => {
        // Define features before the map function
        let features = [];

        // For each vehicle in the data
        data.features.forEach(vehicle => {

            // If a marker for this vehicle already exists
            if (markers[vehicle.properties.vehicle_id]) {
                updateArrow(vehicle)
                // Get the current coordinates of the marker
                var currentCoordinates = markers[vehicle.properties.vehicle_id].getLngLat();
                
                // Calculate the difference in coordinates
                var diffLng = vehicle.geometry.coordinates[0] - currentCoordinates.lng;
                var diffLat = vehicle.geometry.coordinates[1] - currentCoordinates.lat;
        
                // Calculate the number of steps
                var steps = 9000 / 60; // 60 frames per second
        
                // Calculate the step size
                var lngStep = diffLng / steps;
                var latStep = diffLat / steps;
        
                // Start the animation
                var i = 0;
                function animateMarker() {
                    if (i < steps) {
                        // Update the marker's position
                        markers[vehicle.properties.vehicle_id].setLngLat([
                            currentCoordinates.lng + i * lngStep,
                            currentCoordinates.lat + i * latStep
                        ]);
        
                        // Request the next frame of the animation
                        requestAnimationFrame(animateMarker);
                    }
        
                    i++;
                }
        
                animateMarker();
            } else {
                // Otherwise, create a new marker
                const el = document.createElement('div');
                el.className = 'marker';
                el.style.backgroundImage = `url(https://lacmta.github.io/metro-iconography/icon_rail_live-vehicle.svg)`;
                el.style.backgroundRepeat = 'no-repeat';
                el.style.backgroundSize = 'cover';
                el.style.backgroundPosition = 'center';
                el.style.backgroundColor = 'white';
                el.style.borderRadius = '50%';
                el.style.cursor = 'pointer';
                el.style.width = `32px`;
                el.style.height = `32px`;
                // Create an arrow element
                const arrow = document.createElement('div');
                arrow.className = 'arrow';
                arrow.style.borderLeft = '5px solid transparent';
                arrow.style.borderRight = '5px solid transparent';
                arrow.style.borderBottom = '10px solid black';
                arrow.style.position = 'absolute';

                // Calculate arrow position based on heading
                const heading = vehicle.properties.position_bearing;
                const radius = 16; // Half the size of the marker
                const radian = (heading - 90) * (Math.PI / 180); // Convert heading to radian and adjust it by -90 degrees
                const arrowSize = 5; // Half the size of the arrow
                const left = radius + (radius - arrowSize) * Math.cos(radian); // Calculate the left property
                const bottom = radius + (radius - arrowSize) * Math.sin(radian); // Calculate the bottom property

                arrow.style.left = `${left}px`;
                arrow.style.bottom = `-${bottom}px`;
                arrow.style.transform = `rotate(${heading}deg)`;
                arrow.style.transformOrigin = '50% 50%'; // Set the origin of the transformation to the center of the arrow

                // Append the arrow to the marker
                el.appendChild(arrow);                el.addEventListener('click', () => {
                    new maplibregl.Popup()
                    .setHTML(`<h3>${vehicle.properties.vehicle_id}</h3>`)
                });

                // Create the marker and add it to the map
                const marker = new maplibregl.Marker({element: el})
                    .setLngLat(vehicle.geometry.coordinates)
                    .addTo(map);

                // Add the marker to the map of markers
                markers[vehicle.properties.vehicle_id] = marker;
            }

            // Update features inside the map function
            const feature = {
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [vehicle.geometry[0], vehicle.geometry[1]]
                },
                properties: {
                    Heading: vehicle.properties.bearing * 45
                }
            };
            features.push(feature);
        });

        map.getSource('vehicles').setData({
            type: 'FeatureCollection',
            features: features
        });

        // Update the Updated at
        const now = new Date();
        updateTimeDiv.textContent = `Updated at ${now.toLocaleTimeString()}`;
    });

}, 9000);


// Function to update the arrow's direction
function updateArrow(vehicle) {
    // Get the arrow element
    const arrow = markers[vehicle.properties.vehicle_id].getElement().querySelector('.arrow');

    // Calculate arrow position based on heading
    const heading = vehicle.properties.position_bearing;
    const radius = 16; // Half the size of the marker
    const radian = (heading - 90) * (Math.PI / 180); // Convert heading to radian and adjust it by -90 degrees
    const arrowSize = 5; // Half the size of the arrow
    const left = radius + (radius - arrowSize) * Math.cos(radian); // Calculate the left property
    const bottom = radius + (radius - arrowSize) * Math.sin(radian); // Calculate the bottom property

    arrow.style.left = `${left}px`;
    arrow.style.bottom = `-${bottom}px`;
    arrow.style.transform = `rotate(${heading}deg)`;
    arrow.style.transformOrigin = '50% 50%'; // Set the origin of the transformation to the center of the arrow
}

// Call the updateArrow function whenever the map moves
let features = [];
    map.addSource('openmaptiles', {
      url: `https://api.maptiler.com/tiles/v3/tiles.json?key=${MAPTILER_KEY}`,
      type: 'vector',
  });


      map.addLayer({
        'id': 'vehicles',
        'type': 'symbol',
        'source': 'vehicles',
        'layout': {
            'icon-image': 'rail',
            'icon-allow-overlap': true,
            'icon-ignore-placement': true
        }
    });
      map.addLayer(
          {
              'id': '3d-buildings',
              'source': 'openmaptiles',
              'source-layer': 'building',
              'type': 'fill-extrusion',
              'minzoom': 14,
              'paint': {
                  'fill-extrusion-color': [
                      'interpolate',
                      ['linear'],
                      ['get', 'render_height'],0, 'lightgray', 200, 'hsl(38, 28%, 77%)', 400, 'hsl(38, 28%, 77%)'
                  ],
                  'fill-extrusion-opacity': 0.5,
                  'fill-extrusion-height': [
                      'interpolate',
                      ['linear'],
                      ['zoom'],
                      15,
                      0,
                      16,
                      ['get', 'render_height']
                  ],
                  'fill-extrusion-base': ['case',
                      ['>=', ['get', 'zoom'], 16],
                      ['get', 'render_min_height'], 0
                  ]
              }
          },
          labelLayerId
      );

    });
// Add navigation controls to the map
// Add navigation controls to the top-left corner of the map
map.addControl(new maplibregl.NavigationControl(), 'top-left');
    // Create a home button
class HomeControl {
    onAdd(map) {
        this.map = map;
        this.container = document.createElement('div');
        this.container.className = 'maplibregl-ctrl';
        const button = document.createElement('button');
        button.className = 'maplibregl-ctrl-icon home-icon'; // Add 'home-icon' class
        button.innerHTML = '<i class="fas fa-home"></i>';
        button.addEventListener('click', () => {
            this.map.flyTo({
                center: [-118.25133692966446, 34.05295151499077],
                zoom: 9,
                pitch: 20,
                bearing: 0
            });
        });
        this.container.appendChild(button);
        return this.container;
    }

    onRemove() {
        this.container.parentNode.removeChild(this.container);
        this.map = undefined;
    }
}


</script>
</body>
<script>
    // Add the home control to the map
map.addControl(new HomeControl(), 'top-left');

</script>
</html>
